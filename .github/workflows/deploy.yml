name: Build and Deploy

on:
  push:
    branches: [ main, production ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install NPM dependencies
      run: npm ci
    
    - name: Build assets
      run: npm run build
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, pdo_mysql, openssl, tokenizer, xml, ctype, json, fileinfo
    
    - name: Create required directories
      run: |
        # Criar diretórios necessários para o Laravel
        mkdir -p bootstrap/cache
        mkdir -p storage/framework/cache/data
        mkdir -p storage/framework/sessions
        mkdir -p storage/framework/views
        mkdir -p storage/logs
        # Garantir permissões de escrita (775 para diretórios, 664 para arquivos)
        chmod -R 775 bootstrap/cache
        chmod -R 775 storage
        # Garantir que o diretório cache/data existe e é gravável
        touch bootstrap/cache/.gitkeep 2>/dev/null || true
        touch storage/framework/cache/data/.gitkeep 2>/dev/null || true
    
    - name: Install Composer dependencies
      run: composer install --no-dev --optimize-autoloader --no-interaction
    
    - name: Create deployment package
      run: |
        mkdir -p deploy-package
        # Copiar arquivos necessários (excluindo node_modules, etc)
        rsync -av --exclude='node_modules' --exclude='.git' --exclude='.github' \
          --exclude='tests' --exclude='.env' --exclude='storage/logs/*' \
          . deploy-package/
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deployment-package
        path: deploy-package/
        retention-days: 7
        if-no-files-found: warn

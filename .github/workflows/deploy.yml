name: Deploy PHP to HostGator

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v3

      - name: Definir porta SSH
        id: ssh_port
        run: |
          if [ -z "${{ secrets.SSH_PORT }}" ]; then
            echo "port=2222" >> $GITHUB_OUTPUT
          else
            echo "port=${{ secrets.SSH_PORT }}" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to HostGator
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ steps.ssh_port.outputs.port }}
          script_stop: true
          debug: false
          command_timeout: 10m
          timeout: 60s
          script: |
            echo "ðŸš€ Iniciando deploy..."
            echo "ðŸ“ DiretÃ³rio atual: $(pwd)"
            echo "ðŸ‘¤ UsuÃ¡rio: $(whoami)"
            echo "ðŸ’¾ EspaÃ§o em disco:"
            df -h
            
            echo "ðŸ“‚ Navegando para o diretÃ³rio do projeto..."
            echo "ðŸ“ DiretÃ³rio antes: $(pwd)"
            
            # Definir diretÃ³rio do projeto (usar secret ou padrÃ£o)
            if [ -n "${{ secrets.SSH_DIRECTORY }}" ]; then
              PROJECT_DIR="${{ secrets.SSH_DIRECTORY }}"
            else
              PROJECT_DIR="adv.joelsouza.com.br"
            fi
            cd $PROJECT_DIR || {
              echo "âŒ Erro: NÃ£o foi possÃ­vel acessar o diretÃ³rio $PROJECT_DIR"
              echo "ðŸ“ Listando diretÃ³rios disponÃ­veis:"
              ls -la ../
              exit 1
            }
            
            echo "ðŸ“ DiretÃ³rio depois: $(pwd)"
            echo "ðŸ“‹ ConteÃºdo do diretÃ³rio:"
            ls -la
            
            echo "ðŸ” Verificando se Ã© o diretÃ³rio correto:"
            if [ -f "index.php" ] || [ -f "composer.json" ]; then
              echo "âœ… DiretÃ³rio do projeto encontrado!"
            else
              echo "âš ï¸ Arquivos do projeto nÃ£o encontrados, mas continuando..."
            fi
            
            echo "ðŸ”§ Configurando Git..."
            git config --global user.email "deploy@github.com"
            git config --global user.name "GitHub Actions"
            
            echo "ðŸ“¥ Verificando status do Git..."
            git status || echo "âš ï¸ Git nÃ£o estÃ¡ inicializado neste diretÃ³rio"
            git remote -v || echo "âš ï¸ Remote nÃ£o configurado"
            
            echo "â¬‡ï¸ Fazendo pull do repositÃ³rio..."
            git pull origin main || {
              echo "âš ï¸ Erro ao fazer pull. Tentando fetch e merge..."
              git fetch origin main
              git merge origin/main || echo "âš ï¸ Conflitos ou erros no merge"
            }
            
            echo "ðŸ“¦ Verificando PHP..."
            php -v
            
            echo "ðŸ“¦ Verificando Composer..."
            if command -v composer &> /dev/null; then
              composer --version
              echo "âš™ï¸ Instalando dependÃªncias do Composer..."
              composer install --no-dev --optimize-autoloader --no-interaction || {
                echo "âš ï¸ Erro ao instalar dependÃªncias do Composer"
                echo "Tentando com composer.phar local..."
                if [ -f "composer.phar" ]; then
                  php composer.phar install --no-dev --optimize-autoloader --no-interaction
                else
                  echo "âš ï¸ Composer nÃ£o encontrado. Instalando localmente..."
                  php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
                  php composer-setup.php --install-dir=. --filename=composer.phar
                  php composer.phar install --no-dev --optimize-autoloader --no-interaction
                  php -r "unlink('composer-setup.php');" 2>/dev/null || true
                fi
              }
            else
              echo "âš ï¸ Composer nÃ£o encontrado globalmente. Instalando localmente..."
              php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
              php composer-setup.php --install-dir=. --filename=composer.phar
              php composer.phar install --no-dev --optimize-autoloader --no-interaction
              php -r "unlink('composer-setup.php');" 2>/dev/null || true
            fi
            
            echo "âœ… Verificando instalaÃ§Ã£o do Composer..."
            if [ -f "vendor/autoload.php" ]; then
              echo "âœ… vendor/autoload.php criado com sucesso!"
            else
              echo "âš ï¸ vendor/autoload.php nÃ£o foi criado"
            fi
            
            echo "ðŸ” Verificando permissÃµes de arquivos..."
            chmod -R 755 . 2>/dev/null || echo "âš ï¸ NÃ£o foi possÃ­vel alterar todas as permissÃµes"
            chmod -R 755 vendor/ 2>/dev/null || echo "âš ï¸ DiretÃ³rio vendor nÃ£o existe ainda"
            
            echo "âœ… Deploy concluÃ­do com sucesso!"
            echo "ðŸ“Š Status final:"
            echo "   - PHP: $(php -v | head -n 1)"
            echo "   - Composer: $(composer --version 2>/dev/null || php composer.phar --version 2>/dev/null || echo 'NÃ£o instalado')"
            echo "   - DiretÃ³rio: $(pwd)"
            echo "   - Branch: $(git branch --show-current 2>/dev/null || echo 'N/A')"

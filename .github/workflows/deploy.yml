name: Build and Deploy

on:
  push:
    branches: [ main, production ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install NPM dependencies
      run: npm ci
    
    - name: Build assets
      run: npm run build
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, pdo_mysql, openssl, tokenizer, xml, ctype, json, fileinfo
    
    - name: Prepare Laravel directories
      run: |
        # Criar todos os diretórios necessários para o Laravel funcionar
        # O Laravel precisa do bootstrap/cache para executar package:discover durante composer install
        mkdir -p bootstrap/cache
        mkdir -p storage/framework/cache/data
        mkdir -p storage/framework/sessions
        mkdir -p storage/framework/views
        mkdir -p storage/logs
        
        # Garantir que os diretórios e arquivos são graváveis
        # No GitHub Actions, garantir permissões explícitas resolve problemas comuns
        chmod -R 775 bootstrap/cache 2>/dev/null || true
        chmod -R 775 storage 2>/dev/null || true
        
        # Verificar se o diretório bootstrap/cache é gravável
        if [ -w "bootstrap/cache" ]; then
          echo "✓ bootstrap/cache é gravável"
        else
          echo "⚠ Aviso: bootstrap/cache pode não ser gravável, tentando corrigir..."
          chmod 777 bootstrap/cache
        fi
        
        # Listar conteúdo para debug (se necessário)
        echo "Conteúdo de bootstrap/cache:"
        ls -la bootstrap/cache/ || echo "Diretório vazio ou não acessível"
    
    - name: Install Composer dependencies
      run: composer install --no-dev --optimize-autoloader --no-interaction
    
    - name: Create deployment package
      run: |
        mkdir -p deploy-package
        # Copiar arquivos necessários (excluindo node_modules, etc)
        rsync -av --exclude='node_modules' --exclude='.git' --exclude='.github' \
          --exclude='tests' --exclude='.env' --exclude='storage/logs/*' \
          . deploy-package/
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deployment-package
        path: deploy-package/
        retention-days: 7
        if-no-files-found: warn

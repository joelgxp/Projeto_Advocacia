name: Deploy Laravel to HostGator

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v3

      - name: Configurar GitHub CLI
        run: |
          echo "ğŸ”‘ Configurando GitHub CLI..."
          echo ${{ secrets.GITHUB_TOKEN }} | gh auth login --with-token
          echo "âœ… Status da autenticaÃ§Ã£o:"
          gh auth status
          echo "ğŸ“‹ UsuÃ¡rio configurado:"
          gh auth status --show-token

      - name: Testar conexÃ£o SSH
        run: |
          echo "ğŸ”Œ Testando conexÃ£o SSH..."
          echo "Host: 108.167.132.248"
          echo "UsuÃ¡rio: hotel631"
          echo "Porta: 22"
          echo "Testando conectividade..."
          nc -zv 108.167.132.248 22 || echo "âŒ Porta 22 nÃ£o estÃ¡ acessÃ­vel"

      - name: Deploy to HostGator
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 108.167.132.248
          username: hotel631
          password: leiviton00
          port: 22
          script: |
            echo "ğŸš€ Iniciando deploy..."
            echo "ğŸ“ DiretÃ³rio atual: $(pwd)"
            echo "ğŸ‘¤ UsuÃ¡rio: $(whoami)"
            echo "ğŸ’¾ EspaÃ§o em disco:"
            df -h
            
            echo "ğŸ“‚ Navegando para o diretÃ³rio..."
            echo "ğŸ“ DiretÃ³rio antes: $(pwd)"
            cd adv.joelsouza.com.br
            echo "ğŸ“ DiretÃ³rio depois: $(pwd)"
            echo "ğŸ“‹ ConteÃºdo do diretÃ³rio:"
            ls -la
            echo "ğŸ” Verificando se Ã© o diretÃ³rio correto:"
            if [ -f "index.php" ]; then
              echo "âœ… index.php encontrado - DiretÃ³rio correto!"
            else
              echo "âŒ index.php NÃƒO encontrado - DiretÃ³rio incorreto!"
              echo "ğŸ“ Listando diretÃ³rios disponÃ­veis:"
              ls -la ../
            fi
            
            echo "ğŸ”§ Configurando Git..."
            git config --global user.email "deploy@github.com"
            git config --global user.name "GitHub Actions"
            git config --list | grep user
            
            echo "ğŸ“¥ Verificando status do Git..."
            git status
            git remote -v
            
            echo "â¬‡ï¸ Fazendo pull..."
            git pull origin main
            
            echo "ğŸ“¦ Verificando Composer..."
            composer --version
            echo "âš™ï¸ Instalando dependÃªncias..."
            composer install --no-dev --optimize-autoloader
            
            echo "ğŸ”„ Verificando Laravel..."
            php artisan --version
            echo "ğŸ—„ï¸ Executando migrations..."
            php artisan migrate --force
            
            echo "ğŸ§¹ Limpando cache..."
            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear
            php artisan view:clear
            
            echo "âš¡ Gerando cache otimizado..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            echo "âœ… Deploy concluÃ­do com sucesso!"
            echo "ğŸ“Š Status final:"
            php artisan about
